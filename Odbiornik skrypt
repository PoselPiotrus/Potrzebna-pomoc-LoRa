#include <SoftwareSerial.h>

SoftwareSerial wioSerial(2, 3); // RX, TX dla Wio-E5

void setup() {
  Serial.begin(9600);          // Serial Monitor
  wioSerial.begin(9600);       // Komunikacja z Wio-E5
  Serial.println("Odbiornik LoRa TEST");

  // Ustawienia trybu TEST i parametrów odbioru
  wioSerial.println("AT+MODE=TEST");
  delay(1000);
  wioSerial.println("AT+TEST=RFCFG,868,SF12,125,12,15,14,ON,OFF,OFF");
  delay(1000);
  wioSerial.println("AT+TEST=RXLRPKT"); // Rozpoczęcie nasłuchiwania
  delay(1000);
}

void loop() {
 // Sprawdzenie, czy są dostępne dane do odczytu
  if (wioSerial.available()) {
    String hexResponse = wioSerial.readStringUntil('\n');
    Serial.println("Odebrano (HEX): " + hexResponse);

    // Sprawdzenie, czy odebrane dane zawierają prefiks "+TEST: RX"
    if (hexResponse.startsWith("+TEST: RX \"")) {
      // Wyodrębnienie samej treści heksadecymalnej
      int startIndex = hexResponse.indexOf("\"") + 1;
      int endIndex = hexResponse.lastIndexOf("\"");
      String hexData = hexResponse.substring(startIndex, endIndex);

      // Konwersja heksadecymalnej wiadomości na tekst
      String decodedMessage = "";
      for (int i = 0; i < hexData.length(); i += 2) {
        String hexByte = hexData.substring(i, i + 2); // Pobiera dwa znaki heksadecymalne
        char decodedChar = (char) strtol(hexByte.c_str(), NULL, 16); // Konwersja do ASCII
        decodedMessage += decodedChar; // Dodaje znak do wiadomości
      }

      // Wyświetlenie zdekodowanej wiadomości
      Serial.println("Odebrano (tekst): " + decodedMessage);
    }
  }
  delay(500); // Krótkie opóźnienie przed kolejnym nasłuchem
}

  }
}
